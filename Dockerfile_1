# --- Builder Stage ---
FROM ubuntu:24.04 AS builder

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y \
        git \
        cmake \
        ninja-build \
        build-essential \
        libboost-program-options-dev \
        libboost-graph-dev \
        libboost-system-dev \
        libeigen3-dev \
        libopenimageio-dev \
        openimageio-tools \
        libmetis-dev \
        libgoogle-glog-dev \
        libgtest-dev \
        libgmock-dev \
        libsqlite3-dev \
        libglew-dev \
        qt6-base-dev \
        libqt6opengl6-dev \
        libqt6openglwidgets6 \
        libcgal-dev \
        libceres-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libmkl-full-dev \
        libpng-dev \
        libjpeg-dev \
        libtiff-dev \
        libglu1-mesa-dev \
        libglew-dev \
        libglfw3-dev \
        libboost-iostreams-dev \
        libboost-serialization-dev \
        libopencv-dev \
        libboost-thread-dev \
        libgmp-dev \
        libmpfr-dev \
        zlib1g-dev \
        python3-dev \
        libnanoflann-dev \
        libjxl-dev && \
    rm -rf /var/lib/apt/lists/*

# Fix potential issue with OpenImageIO's OpenCV dependency
RUN mkdir -p /usr/include/opencv4

# Build and install COLMAP first (using system Eigen/Ceres)
ARG COLMAP_GIT_COMMIT=main
RUN git clone https://github.com/colmap/colmap.git && \
    cd colmap && \
    git fetch https://github.com/colmap/colmap.git ${COLMAP_GIT_COMMIT} && \
    git checkout FETCH_HEAD && \
    mkdir build && \
    cd build && \
    # Note: BUILD_CUDA_TOOLS is OFF, BLA_VENDOR is Intel10_64lp
    cmake .. \
        -GNinja \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/colmap-install \
        -DBUILD_CUDA_TOOLS=OFF \
        -DBLA_VENDOR=Intel10_64lp && \
    ninja install

# Now build and install Eigen (required by OpenMVS) - this might override system headers
RUN git clone https://gitlab.com/libeigen/eigen.git --branch 3.4 && \
    mkdir eigen_build && \
    cd eigen_build && \
    cmake ../eigen \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr/local && \
    make -j$(nproc) && make install && \
    cd .. && rm -rf eigen_build eigen

# Build and install CGAL (required by OpenMVS)
RUN git clone https://github.com/CGAL/cgal.git --branch=v6.0.1 && \
    mkdir cgal_build && \
    cd cgal_build && \
    cmake ../cgal \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr/local && \
    make -j$(nproc) && make install && \
    cd .. && rm -rf cgal_build cgal

# Build and install OpenMVS
RUN git clone https://github.com/cdcseacave/openMVS.git && \
    git clone https://github.com/cdcseacave/VCG.git vcglib && \
    mkdir openMVS_build && \
    cd openMVS_build && \
    # Note: OpenMVS_USE_CUDA is OFF. Set CMAKE_PREFIX_PATH to find manually installed Eigen/CGAL
    cmake ../openMVS \
        -DCMAKE_BUILD_TYPE=Release \
        -DVCG_ROOT=/vcglib \
        -DOpenMVS_USE_CUDA=OFF \
        -DCMAKE_INSTALL_PREFIX=/usr/local \
        -DCMAKE_PREFIX_PATH="/usr/local;/usr" && \
    make -j$(nproc) && make install && \
    cd .. && rm -rf openMVS_build vcglib


# --- Runtime Stage ---
FROM ubuntu:24.04 AS runtime

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y --no-install-recommends --no-install-suggests \
        libboost-program-options1.83.0 \
        libc6 \
        libomp5 \
        libopengl0 \
        libmetis5 \
        libceres4t64 \
        libopenimageio2.4t64 \
        libgcc-s1 \
        libgl1 \
        libglew2.2 \
        libgoogle-glog0v6t64 \
        libqt6core6 \
        libqt6gui6 \
        libqt6widgets6 \
        libqt6openglwidgets6 \
        libcurl4 \
        libssl3t64 \
        libmkl-locale \
        libmkl-intel-lp64 \
        libmkl-intel-thread \
        libmkl-core \
        libpng16-16 \
        libjpeg-turbo8 \
        libtiff6 \
        libglu1-mesa \
        libglfw3 \
        libboost-iostreams1.83.0 \
        libboost-program-options1.83.0 \
        libboost-system1.83.0 \
        libopencv-imgcodecs-dev \
        libboost-serialization1.83.0 \
        libboost-thread1.83.0 \
        libgmp10 \
        libmpfr6 \
        zlib1g \
        ca-certificates && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Copy installed libraries and executables from builder stage
COPY --from=builder /usr/local/lib /usr/local/lib
COPY --from=builder /usr/local/bin /usr/local/bin
# Copy COLMAP installation from builder stage
COPY --from=builder /colmap-install/ /usr/local/

# Update the dynamic linker cache to recognize new libraries
RUN ldconfig

# Set the working directory
WORKDIR /workspace

# Example: Command to run bash (default container command)
CMD ["/bin/bash"]
