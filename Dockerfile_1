# Dockerfile with COLMAP and OpenMVS (CPU-only version)
# Multi-stage build to keep image size reasonable

# Stage 1: Builder stage for both COLMAP and OpenMVS
ARG UBUNTU_VERSION=24.04
ARG COLMAP_GIT_COMMIT=main
ARG OPENMVS_BRANCH=develop

FROM ubuntu:${UBUNTU_VERSION} AS builder

ENV DEBIAN_FRONTEND=noninteractive
ENV QT_XCB_GL_INTEGRATION=xcb_egl

# Install common dependencies for both COLMAP and OpenMVS (CPU version)
RUN apt-get update && \
    apt-get install -y \
        git \
        cmake \
        ninja-build \
        build-essential \
        wget \
        unzip \
        libboost-program-options-dev \
        libboost-graph-dev \
        libboost-system-dev \
        libboost-iostreams-dev \
        libboost-serialization-dev \
        libboost-thread-dev \
        libeigen3-dev \
        libopenimageio-dev \
        openimageio-tools \
        libmetis-dev \
        libgoogle-glog-dev \
        libgtest-dev \
        libgmock-dev \
        libsqlite3-dev \
        libglew-dev \
        libglu1-mesa-dev \
        libglfw3-dev \
        qt6-base-dev \
        libqt6opengl6-dev \
        libqt6openglwidgets6 \
        libcgal-dev \
        libceres-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libpng-dev \
        libjpeg-dev \
        libtiff-dev \
        libopencv-dev \
        libgmp-dev \
        libmpfr-dev \
        zlib1g-dev \
        python3-dev \
        pkg-config

# Fix issue in Ubuntu's openimageio CMake config
RUN mkdir -p /usr/include/opencv4

# Build and install COLMAP (CPU version)
RUN git clone https://github.com/colmap/colmap.git
RUN cd colmap && \
    git fetch https://github.com/colmap/colmap.git ${COLMAP_GIT_COMMIT} && \
    git checkout FETCH_HEAD && \
    mkdir build && \
    cd build && \
    cmake .. \
        -GNinja \
        -DCMAKE_INSTALL_PREFIX=/colmap-install \
        -DCUDA_ENABLED=OFF \
        -DBLA_VENDOR=OpenBLAS && \
    ninja install

# Build and install Eigen (for OpenMVS)
RUN git clone https://gitlab.com/libeigen/eigen --branch 3.4 && \
    mkdir eigen_build && \
    cd eigen_build && \
    cmake . ../eigen && \
    make && make install && \
    cd .. && rm -rf eigen_build eigen

# Build and install CGAL
RUN git clone https://github.com/cgal/cgal --branch=v6.0.1 && \
    mkdir cgal_build && \
    cd cgal_build && \
    cmake . ../cgal && \
    make && make install && \
    cd .. && rm -rf cgal_build cgal

# Clone VCG library for OpenMVS
RUN git clone https://github.com/cdcseacave/VCG.git vcglib

# Clone and build OpenMVS (CPU version)
RUN if [ "${OPENMVS_BRANCH}" = "master" ]; then \
        git clone https://github.com/cdcseacave/openMVS.git --branch master; \
    else \
        git clone https://github.com/cdcseacave/openMVS.git --branch develop; \
    fi

RUN mkdir openMVS_build && \
    cd openMVS_build && \
    cmake . ../openMVS \
        -DCMAKE_BUILD_TYPE=Release \
        -DVCG_ROOT=/vcglib \
        -DCMAKE_INSTALL_PREFIX=/openmvs-install \
        -DOpenMVS_USE_CUDA=OFF && \
    make -j$(nproc) && \
    make install && \
    cd .. && rm -rf openMVS_build vcglib openMVS

# Stage 2: Runtime stage
FROM ubuntu:${UBUNTU_VERSION} AS runtime

ENV DEBIAN_FRONTEND=noninteractive

# Install runtime dependencies for both COLMAP and OpenMVS (CPU version)
RUN apt-get update && \
    apt-get install -y --no-install-recommends --no-install-suggests \
        libboost-program-options1.83.0 \
        libboost-system1.83.0 \
        libboost-iostreams1.83.0 \
        libboost-serialization1.83.0 \
        libboost-graph1.83.0 \
        libboost-thread1.83.0 \
        libc6 \
        libomp5 \
        libopengl0 \
        libmetis5 \
        libceres4t64 \
        libopenimageio2.4t64 \
        libgcc-s1 \
        libgl1 \
        libglew2.2 \
        libgoogle-glog0v6t64 \
        libqt6core6 \
        libqt6gui6 \
        libqt6widgets6 \
        libqt6openglwidgets6 \
        libcurl4 \
        libssl3t64 \
        libpng16-16 \
        libjpeg-turbo8 \
        libtiff6 \
        libopencv-dev \
        libgmp10 \
        libmpfr6 \
        zlib1g \
        python3 \
        libglu1-mesa \
        libglfw3 \
        libblas3 \
        liblapack3 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install OpenBLAS for CPU acceleration
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        libopenblas-dev \
        libopenblas-base && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Copy COLMAP installation
COPY --from=builder /colmap-install/ /usr/local/

# Copy OpenMVS installation
COPY --from=builder /openmvs-install/ /usr/local/

# Create a non-root user for running the applications
RUN groupadd -r -g 1000 appuser && \
    useradd -r -u 1000 -g appuser -m -s /bin/bash appuser && \
    mkdir -p /workspace && \
    chown -R appuser:appuser /workspace

# Set working directory
WORKDIR /workspace

# Switch to non-root user
USER appuser

# Set environment variables
ENV PATH="/usr/local/bin:${PATH}"
ENV LD_LIBRARY_PATH="/usr/local/lib:${LD_LIBRARY_PATH}"
ENV OMP_NUM_THREADS=4

# Test commands availability
RUN command -v colmap && echo "COLMAP (CPU) installed successfully" && \
    command -v DensifyPointCloud && echo "OpenMVS (CPU) installed successfully"

# Default command
CMD ["bash"]
