好的，看来问题的核心——即 Ceres 和 Eigen 的版本冲突——在单个构建阶段内难以通过简单的顺序调整或 CMake 参数来彻底规避。每次我们安装新的 Eigen 版本到 `/usr/local`，它就会影响后续在同一阶段内运行的 CMake 配置过程。

您提出的**多阶段构建**或**环境变量隔离**是解决这类问题的有效思路。特别是**多阶段构建**，它能提供更强的隔离性。

**解决思路分析：**

1.  **环境变量 (`LD_LIBRARY_PATH`, `CPATH`, `PKG_CONFIG_PATH` 等)**: 在单个构建阶段内，通过修改环境变量来影响 CMake 的查找行为是一种方法。例如，在构建 COLMAP 时，可以临时将 `CMAKE_PREFIX_PATH` 设置为只包含系统路径（`/usr`），从而避免找到 `/usr/local` 中的 Eigen。但这需要非常小心地管理每个步骤的环境，容易出错且不够优雅。
2.  **多阶段构建 (Multi-stage Builds)**: 这是最推荐的方法。我们可以创建三个阶段：
    *   **Stage 1 (`deps-builder`)**: 安装所有基础依赖，构建并安装手动需要的库（Eigen, Ceres, OpenCV, CGAL headers）。
    *   **Stage 2 (`colmap-builder`)**: 从 `deps-builder` 复制基础依赖和手动库，但**专门用于构建 COLMAP**。在此阶段，我们可以通过不将 `/usr/local/lib` 添加到 CMake 查找路径，或者通过设置特定的 CMake 变量（如 `CERES_ROOT`, `EIGEN3_ROOT`）来强制 COLMAP 使用系统库（或者更精确地，使用我们期望的库版本）。或者，更直接地，此阶段可以只使用从 `deps-builder` 复制过来的库，其中 Ceres 是用我们期望的 Eigen 版本编译的。
    *   **Stage 3 (`openmvs-builder`)**: 从 `deps-builder` 复制所有库，从 `colmap-builder` 复制编译好的 COLMAP。在此阶段构建 OpenMVS，它可以自由地使用 `/usr/local` 中的所有手动安装的库。
    *   **Stage 4 (`runtime`)**: 从 `openmvs-builder` 复制所有编译好的二进制文件和库。

    这种方式通过 Docker 的层隔离，确保了 COLMAP 构建时的环境不会受到 OpenMVS 构建所需库的影响，反之亦然。

**基于多阶段构建的 Dockerfile:**

```dockerfile
# --- Stage 1: Build and install common dependencies (Eigen, Ceres, OpenCV, CGAL) ---
FROM ubuntu:24.04 AS deps-builder

ARG DEBIAN_FRONTEND=noninteractive

# Install ALL base dependencies upfront
RUN apt-get update && \
    apt-get install -y \
        git \
        cmake \
        ninja-build \
        build-essential \
        # Dependencies for building Ceres
        libgoogle-glog-dev \
        libgflags-dev \
        libatlas-base-dev \
        libsuitesparse-dev \
        # Other dependencies for COLMAP/OpenMVS
        libboost-program-options-dev \
        libboost-graph-dev \
        libboost-system-dev \
        libeigen3-dev \
        libopenimageio-dev \
        openimageio-tools \
        libmetis-dev \
        libgtest-dev \
        libgmock-dev \
        libsqlite3-dev \
        libglew-dev \
        qt6-base-dev \
        libqt6opengl6-dev \
        libqt6openglwidgets6 \
        libboost-program-options-dev \
        libboost-system-dev \
        libboost-thread-dev \
        libgmp-dev \
        libmpfr-dev \
        zlib1g-dev \
        libpng-dev \
        libjpeg-dev \
        libtiff-dev \
        libglu1-mesa-dev \
        libglew-dev \
        libglfw3-dev \
        libboost-iostreams-dev \
        libboost-serialization-dev \
        libopencv-dev \
        libboost-thread-dev \
        python3-dev \
        libnanoflann-dev \
        libjxl-dev \
        libjxl-tools \
        wget \
        unzip \
        pkg-config && \
    rm -rf /var/lib/apt/lists/*

RUN mkdir -p /usr/include/opencv4

# 1. Build and install Eigen
RUN git clone https://gitlab.com/libeigen/eigen.git --branch 3.4 && \
    mkdir eigen_build && \
    cd eigen_build && \
    cmake ../eigen \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr/local && \
    make -j$(nproc) && make install && \
    cd .. && rm -rf eigen_build eigen

# 2. Build and install Ceres (linked against manually installed Eigen)
RUN git clone https://github.com/ceres-solver/ceres-solver.git && \
    cd ceres-solver && \
    git checkout 2.2.0 && \
    mkdir build && \
    cd build && \
    cmake .. \
        -GNinja \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr/local \
        -DBUILD_SHARED_LIBS=ON \
        -DBUILD_TESTING=OFF \
        -DBUILD_EXAMPLES=OFF && \
    ninja && ninja install && \
    cd ../.. && rm -rf ceres-solver

# 3. Copy CGAL headers (header-only library)
RUN git clone https://github.com/CGAL/cgal.git --branch=v6.0.1 && \
    cd cgal && \
    cp -r Installation/include/CGAL /usr/local/include/ && \
    cd .. && rm -rf cgal

# 4. Build and install OpenCV
RUN wget -O opencv.zip https://github.com/opencv/opencv/archive/refs/tags/4.13.0.zip && \
    wget -O opencv_contrib.zip https://github.com/opencv/opencv_contrib/archive/refs/tags/4.13.0.zip && \
    unzip opencv.zip && \
    unzip opencv_contrib.zip && \
    mv opencv-4.13.0 opencv && \
    mv opencv_contrib-4.13.0 opencv_contrib && \
    rm opencv.zip opencv_contrib.zip

RUN mkdir opencv_build && \
    cd opencv_build && \
    cmake ../opencv \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr/local \
        -DOPENCV_EXTRA_MODULES_PATH=/opencv_contrib/modules \
        -DBUILD_opencv_world=OFF \
        -DBUILD_TESTS=OFF \
        -DBUILD_PERF_TESTS=OFF \
        -DBUILD_EXAMPLES=OFF \
        -DBUILD_JAVA=OFF \
        -DBUILD_opencv_python2=OFF \
        -DBUILD_opencv_python3=ON \
        -DWITH_JPEGXL=ON \
        -DWITH_JPEG=ON \
        -DWITH_PNG=ON \
        -DWITH_TIFF=ON \
        -DWITH_WEBP=ON \
        -DWITH_OPENJPEG=ON \
        -DWITH_OPENEXR=ON \
        -DWITH_GTK=ON \
        -DWITH_FFMPEG=ON \
        -DWITH_GSTREAMER=OFF \
        -DWITH_1394=OFF \
        -DWITH_TBB=OFF \
        -DWITH_OPENMP=ON \
        -DWITH_EIGEN=ON \
        -DWITH_V4L=ON \
        -DWITH_LAPACK=ON \
        -DWITH_QT=OFF \
        -DWITH_CUDA=OFF \
        -DWITH_OPENCL=OFF \
        -DWITH_IPP=OFF && \
    make -j$(nproc) && \
    make install && \
    cd .. && \
    rm -rf opencv opencv_contrib opencv_build


# --- Stage 2: Build COLMAP using libraries from deps-builder ---
FROM deps-builder AS colmap-builder

ARG COLMAP_GIT_COMMIT=main
RUN git clone https://github.com/colmap/colmap.git && \
    cd colmap && \
    git fetch https://github.com/colmap/colmap.git ${COLMAP_GIT_COMMIT} && \
    git checkout FETCH_HEAD && \
    mkdir build && \
    cd build && \
    # Ensure CMake finds Ceres and Eigen from /usr/local (where we installed them in deps-builder)
    cmake .. \
        -GNinja \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/colmap-install \
        -DBUILD_CUDA_TOOLS=OFF \
        -DBLA_VENDOR=Intel10_64lp \
        -DCMAKE_PREFIX_PATH="/usr/local;/usr" && \
    ninja install


# --- Stage 3: Build OpenMVS using libraries from deps-builder and COLMAP from colmap-builder ---
FROM deps-builder AS openmvs-builder

# Copy COLMAP installation from colmap-builder stage
COPY --from=colmap-builder /colmap-install /colmap-install

# Build and install OpenMVS
RUN git clone https://github.com/cdcseacave/VCG.git vcglib && \
    git clone https://github.com/cdcseacave/openMVS.git && \
    mkdir openMVS_build && \
    cd openMVS_build && \
    # Ensure OpenMVS CMake finds Eigen/CGAL/OpenCV from /usr/local
    cmake ../openMVS \
        -DCMAKE_BUILD_TYPE=Release \
        -DVCG_ROOT=/vcglib \
        -DOpenMVS_USE_CUDA=OFF \
        -DCMAKE_INSTALL_PREFIX=/usr/local \
        -DCMAKE_PREFIX_PATH="/usr/local;/usr" && \
    make -j$(nproc) && make install && \
    cd .. && rm -rf openMVS_build vcglib openMVS


# --- Stage 4: Runtime ---
FROM ubuntu:24.04 AS runtime

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y --no-install-recommends --no-install-suggests \
        libboost-program-options1.83.0 \
        libc6 \
        libomp5 \
        libopengl0 \
        libmetis5 \
        # libceres4t64 \ # Using manually built Ceres from builder stage
        libopenimageio2.4t64 \
        libgcc-s1 \
        libgl1 \
        libglew2.2 \
        libgoogle-glog0v6t64 \
        libqt6core6 \
        libqt6gui6 \
        libqt6widgets6 \
        libqt6openglwidgets6 \
        libcurl4 \
        libssl3t64 \
        libmkl-locale \
        libmkl-intel-lp64 \
        libmkl-intel-thread \
        libmkl-core \
        libpng16-16 \
        libjpeg-turbo8 \
        libtiff6 \
        libglu1-mesa \
        libglfw3 \
        libboost-iostreams1.83.0 \
        libboost-program-options1.83.0 \
        libboost-system1.83.0 \
        libopencv-imgcodecs-dev \
        libboost-serialization1.83.0 \
        libboost-thread1.83.0 \
        libgmp10 \
        libmpfr6 \
        zlib1g \
        ca-certificates \
        libgtk-3-0 \
        libavcodec60 \
        libavformat60 \
        libswscale7 \
        libv4l-0 \
        libxvidcore4 \
        libx264-164 \
        libopenexr-3-1-30 \
        libwebp7 \
        libopenjp2-7 \
        libjxl-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Copy libraries, executables, and COLMAP installation from openmvs-builder stage
COPY --from=openmvs-builder /usr/local/lib /usr/local/lib
COPY --from=openmvs-builder /usr/local/bin /usr/local/bin
COPY --from=openmvs-builder /colmap-install/ /usr/local/

# Update the dynamic linker cache to recognize new libraries
RUN ldconfig

# Set the working directory
WORKDIR /workspace

# Default command
CMD ["/bin/bash"]
```
